<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ö–æ—Ä–∑–∏–Ω–∞ ‚Äî HandMarket</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="site-header small">
    <div class="container header-row">
      <a href="index.html" style="text-decoration:none; color:white; display:flex; align-items:center; gap:10px">
        <span style="font-size:20px">‚Üê</span> <span class="brand" style="font-size:20px">HandMarket</span>
      </a>
    </div>
  </header>

  <main class="container" style="padding-top: 30px; padding-bottom: 60px;">
    <h1 style="margin-bottom: 10px;">–ö–æ—Ä–∑–∏–Ω–∞</h1>
    
    <div id="cartEmpty" class="empty hidden">
      <div style="font-size: 40px; margin-bottom: 20px;">üõí</div>
      <h2 style="margin-top:0">–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</h2>
      <p>–ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –Ω–∞—à–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —Ç–∞–º –º–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ–≥–æ!</p>
      <a href="index.html" class="btn btn-primary btn-cta">–ü–µ—Ä–µ–π—Ç–∏ –∫ –ø–æ–∫—É–ø–∫–∞–º</a>
    </div>

    <div id="cartContent" class="cart-layout hidden">
      <div class="cart-items" id="cartItemsList"></div>

      <div class="cart-summary">
        <h3 style="margin-top:0; margin-bottom:20px">–í–∞—à –∑–∞–∫–∞–∑</h3>
        
        <div class="summary-row">
          <span>–¢–æ–≤–∞—Ä—ã (<span id="summaryCount">0</span>)</span>
          <span id="summarySubtotal">0 ‚ÇΩ</span>
        </div>

        <div class="summary-row" id="discountRow" style="color:var(--accent); display:none;">
          <span>–°–∫–∏–¥–∫–∞</span>
          <span id="discountValue">- 0 ‚ÇΩ</span>
        </div>
        
        <div class="summary-row total">
          <span>–ò—Ç–æ–≥–æ:</span>
          <span style="color:var(--accent)" id="summaryTotal">0 ‚ÇΩ</span>
        </div>

        <div class="promo-box" style="margin-bottom: 15px; display: flex; gap: 8px;">
          <input type="text" id="promoInput" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥" style="flex:1; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; outline:none;">
          <button id="applyPromoBtn" class="btn btn-outline" style="border-color: var(--primary); color: var(--primary); padding: 8px 14px;">‚Üí</button>
        </div>
        <div id="promoMessage" style="font-size: 12px; margin-bottom: 15px; display: none;"></div>

        <button class="btn btn-primary w-full btn-cta" id="checkoutBtn">
          –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑
        </button>
        
        <p class="summary-note">
          –ù–∞–∂–∏–º–∞—è –∫–Ω–æ–ø–∫—É, –≤—ã —Å–æ–≥–ª–∞—à–∞–µ—Ç–µ—Å—å —Å —É—Å–ª–æ–≤–∏—è–º–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
        </p>

        <button id="clearCartBtn" class="btn btn-outline w-full" style="border-color:#e2e8f0; color:var(--text-muted); margin-top:10px">
          –û—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É
        </button>
      </div>
    </div>
  </main>

  <script src="script.js"></script>
  <script>
    // CART PAGE LOGIC
    let activeDiscount = 0; // –¥–æ–ª—è (0.10 = 10%)

    const codes = {
      'HAND10': 0.10,
      'SALE2025': 0.15,
      'ADMIN': 0.50
    };

    const promoInput = document.getElementById('promoInput');
    const promoMsg = document.getElementById('promoMessage');
    const applyBtn = document.getElementById('applyPromoBtn');
    const checkoutBtn = document.getElementById('checkoutBtn');

    applyBtn.addEventListener('click', applyPromo);

    function applyPromo() {
      const code = promoInput.value.trim().toUpperCase();
      if (codes[code]) {
        activeDiscount = codes[code];
        promoMsg.style.display = 'block';
        promoMsg.style.color = 'green';
        promoMsg.textContent = `–ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω–µ–Ω! –°–∫–∏–¥–∫–∞ ${activeDiscount * 100}%`;
        renderCartPage();
        if (window.showToast) showToast(`–°–∫–∏–¥–∫–∞ ${activeDiscount * 100}% –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞!`);
      } else {
        activeDiscount = 0;
        promoMsg.style.display = 'block';
        promoMsg.style.color = 'red';
        promoMsg.textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ø—Ä–æ–º–æ–∫–æ–¥';
        renderCartPage();
      }
    }

    function getCartData() {
      return JSON.parse(localStorage.getItem('hm_cart') || '[]');
    }

    function saveCartData(c) {
      localStorage.setItem('hm_cart', JSON.stringify(c));
      renderCartPage();
      if(window.updateCartBadge) window.updateCartBadge();
    }

    const emptyBlock = document.getElementById('cartEmpty');
    const contentBlock = document.getElementById('cartContent');
    const itemsList = document.getElementById('cartItemsList');

    const sumCount = document.getElementById('summaryCount');
    const sumSub = document.getElementById('summarySubtotal');
    const sumTotal = document.getElementById('summaryTotal');

    function renderCartPage() {
      const cart = getCartData();
      if (cart.length === 0) {
        emptyBlock.classList.remove('hidden');
        contentBlock.classList.add('hidden');
        return;
      }
      emptyBlock.classList.add('hidden');
      contentBlock.classList.remove('hidden');

      itemsList.innerHTML = '';
      let totalSum = 0;
      let totalQty = 0;

      cart.forEach((item, index) => {
        const price = Number(item.priceRaw || Number(String(item.price).replace(/\D/g, '')) || 0);
        const rowSum = price * (item.qty || 1);
        totalSum += rowSum;
        totalQty += item.qty || 1;

        const el = document.createElement('div');
        el.className = 'cart-item';
        el.innerHTML = `
          <img src="${item.image}" class="cart-img" alt="">
          <div class="cart-info">
            <div class="cart-name">${item.name}</div>
            <div class="cart-cat">${item.category || '–¢–æ–≤–∞—Ä'}</div>
            <div class="cart-controls">
              <button class="qty-btn" onclick="changeQty(${index}, -1)">‚àí</button>
              <span id="qty-${index}">${item.qty}</span>
              <button class="qty-btn" onclick="changeQty(${index}, 1)">+</button>
            </div>
          </div>
          <div class="cart-price-block">
            <div class="item-total">${rowSum.toLocaleString()} ‚ÇΩ</div>
            <button class="btn-delete" onclick="removeItem(${index})">–£–¥–∞–ª–∏—Ç—å</button>
          </div>
        `;
        itemsList.appendChild(el);
      });

      // —Ä–∞—Å—á–µ—Ç —Å–∫–∏–¥–∫–∏
      const discountAmount = Math.round(totalSum * activeDiscount);
      const finalPrice = totalSum - discountAmount;

      sumCount.textContent = totalQty;
      sumSub.textContent = totalSum.toLocaleString() + ' ‚ÇΩ';

      if (activeDiscount > 0) {
        document.getElementById('discountValue').textContent = `- ${discountAmount.toLocaleString()} ‚ÇΩ`;
        document.getElementById('discountRow').style.display = 'flex';
      } else {
        document.getElementById('discountRow').style.display = 'none';
      }

      sumTotal.textContent = finalPrice.toLocaleString() + ' ‚ÇΩ';
    }

    window.changeQty = (idx, delta) => {
      const cart = getCartData();
      cart[idx].qty = (cart[idx].qty || 1) + delta;
      if (cart[idx].qty < 1) cart[idx].qty = 1;
      saveCartData(cart);
    };

    window.removeItem = (idx) => {
      const cart = getCartData();
      cart.splice(idx, 1);
      saveCartData(cart);
    };

    document.getElementById('clearCartBtn').addEventListener('click', () => {
      if(confirm('–¢–æ—á–Ω–æ –æ—á–∏—Å—Ç–∏—Ç—å –∫–æ—Ä–∑–∏–Ω—É?')) {
        saveCartData([]);
      }
    });

    checkoutBtn.addEventListener('click', () => {
      alert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏.');
      // –≤ —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–¥–µ—Å—å –±—É–¥–µ—Ç –ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ checkout + api
      saveCartData([]);
    });

    // initial
    renderCartPage();
  </script>
</body>
</html>
